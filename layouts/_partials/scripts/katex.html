{{ $version := .Site.Params.katex.version | default "latest" }}

{{ $katex_css_url := printf "https://cdn.jsdelivr.net/npm/katex@%s/dist/katex%s.css" $version (cond hugo.IsProduction ".min" "") }}
{{ $katex_css := resources.GetRemote $katex_css_url }}

{{ with $katex_css }}
  {{ if .Err }}
    {{ errorf "Could not retrieve KaTeX css file from CDN. Reason: %s." .Err }}
  {{ else }}
    {{ with resources.Copy (printf "css/katex%s.css" (cond hugo.IsProduction ".min" "")) . }}
      {{ $secureCSS := . | resources.Fingerprint "sha512" }}
      <link rel="stylesheet" href="{{ .RelPermalink }}" integrity="{{ $secureCSS.Data.Integrity }}" crossorigin="anonymous">
    {{ end }}
  {{ end }}
{{ else }}
  {{ errorf "Invalid KaTeX version %s, could not retrieve this version from CDN." $version }}
{{ end }}

{{ $katex_js_url := printf "https://cdn.jsdelivr.net/npm/katex@%s/dist/katex%s.js" $version (cond hugo.IsProduction ".min" "") }}
{{ $katex_js := resources.GetRemote $katex_js_url }}

{{ with $katex_js }}
  {{ if .Err }}
    {{ errorf "Could not retrieve KaTeX JS from CDN. Reason: %s." .Err }}
  {{ else }}
    {{ with resources.Copy (printf "js/katex%s.js" (cond hugo.IsProduction ".min" "")) . }}
      {{ $secureJS := . | resources.Fingerprint "sha512" }}
      <script defer src="{{ .RelPermalink }}" integrity="{{ $secureJS.Data.Integrity }}" crossorigin="anonymous"></script>
    {{ end }}
  {{ end }}
{{ else }}
  {{ errorf "Invalid KaTeX version %s, could not retrieve this version from CDN." $version }}
{{ end }}

{{ if .mhchem }}
  {{ partial "scripts/mhchem.html" (dict "version" $version) }}
{{ end }}

{{ $katex_autorender_url := printf "https://cdn.jsdelivr.net/npm/katex@%s/dist/contrib/auto-render%s.js" $version (cond hugo.IsProduction ".min" "") }}
{{ $katex_autorender := resources.GetRemote $katex_autorender_url }}

{{ with $katex_autorender }}
  {{ if .Err }}
    {{ errorf "Could not retrieve KaTeX auto-render extension from CDN. Reason: %s." .Err }}
  {{ else }}
    {{ with resources.Copy (printf "js/auto-render%s.js" (cond hugo.IsProduction ".min" "")) . }}
      {{ $secureAuto := . | resources.Fingerprint "sha512" }}
      <script defer src="{{ .RelPermalink }}" integrity="{{ $secureAuto.Data.Integrity }}" crossorigin="anonymous"
        {{ printf "onload='renderMathInElement(%s, %s);'" (( $.Page.Site.Params.katex.html_dom_element | default "document.body" ) | safeJS ) ( printf "%s" ( $.Page.Site.Params.katex.options | jsonify )) | safeHTMLAttr }}>
      </script>
    {{ end }}
  {{ end }}
{{ else }}
  {{ errorf "Invalid KaTeX version %s, could not retrieve this version from CDN." $version }}
{{ end }}